<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistant Vocal iPhone Style Ultra-Rapide</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        /* Tailwind CSS Configuration */
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                    },
                    borderRadius: {
                        '4xl': '2rem',
                        '5xl': '2.5rem',
                    },
                    keyframes: {
                        pulse: {
                            '0%, 100%': { boxShadow: '0 0 0 0 rgba(74, 222, 128, 0.7)' },
                            '70%': { boxShadow: '0 0 0 10px rgba(74, 222, 128, 0)' },
                        },
                        'tts-pulse': {
                            '0%, 100%': { boxShadow: '0 0 0 0 rgba(168, 85, 247, 0.7)' },
                            '70%': { boxShadow: '0 0 0 10px rgba(168, 85, 247, 0)' },
                        },
                        'interrupt-flash': {
                            '0%': { boxShadow: '0 0 0 0 rgba(239, 68, 68, 0.8)' },
                            '50%': { boxShadow: '0 0 0 15px rgba(239, 68, 68, 0.4)' },
                            '100%': { boxShadow: '0 0 0 0 rgba(239, 68, 68, 0)' },
                        },
                        'processing-spin': {
                            '0%': { transform: 'rotate(0deg)' },
                            '100%': { transform: 'rotate(360deg)' },
                        },
                    },
                    animation: {
                        pulse: 'pulse 2s infinite',
                        'tts-pulse': 'tts-pulse 1.5s infinite',
                        'interrupt-flash': 'interrupt-flash 0.5s ease-out',
                        'processing-spin': 'processing-spin 1s linear infinite',
                    },
                },
            },
        };
    </style>
    <style>
        /* Custom Scrollbar Styles */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: rgba(255,255,255,0.1); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 10px; }
        
        /* Toggle Button Animation */
        #toggleButton {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: center;
        }
        #toggleButton:active {
            transform: scale(0.95);
        }
        #toggleButton:disabled {
            transform: scale(1);
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Ultra-Fast Indicator (if needed) */
        .ultra-fast-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(45deg, #00ff00, #ffff00);
            color: black;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            animation: pulse 2s infinite;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-[#1e3a8a] to-[#3730a3] min-h-screen flex items-center justify-center font-sans overflow-hidden">

    <div class="w-full h-full relative flex flex-col items-center justify-start min-h-screen p-5">
        <div class="fixed top-0 left-0 w-full z-10 p-5">
            <div class="flex justify-between items-center text-white text-sm font-semibold">
                <div>1:16 PM</div> <div id="nav-menu-toggle" class="cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </div>
                <div class="flex items-center gap-2">
                    <button id="drawerToggle" class="p-2 rounded-lg bg-white/10 hover:bg-white/20 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                    <button id="conversationToggle" class="p-2 rounded-lg bg-white/10 hover:bg-white/20">
                        üí¨
                    </button>
                </div>
            </div>
        </div>

        <div class="flex-1 flex flex-col w-full max-w-md mx-auto pt-16 pb-20 overflow-hidden">
            <div class="bg-white/10 backdrop-blur-xl rounded-2xl border border-white/20 flex-shrink-0 my-5 overflow-hidden transition-all duration-300 ease-in-out" id="settingsContainer">
                <div class="flex items-center justify-between p-3 cursor-pointer" id="settingsToggle">
                    <div class="flex items-center gap-2">
                        <span class="text-white text-sm font-medium">‚öôÔ∏è Param√®tres</span>
                    </div>
                    <span id="settingsToggleIcon" class="text-white/70 transition-transform duration-300">‚¨áÔ∏è</span>
                </div>
                
                <div id="settingsContent" class="px-5 pb-5 overflow-hidden">
                    <input type="text" id="groqApiKey" placeholder="Cl√© API Groq (STT)" class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white text-sm placeholder-white/60 focus:outline-none focus:border-green-400/50 focus:bg-white/15 mb-3">
                    <input type="text" id="openaiApiKey" placeholder="Cl√© API OpenAI (LLM)" class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white text-sm placeholder-white/60 focus:outline-none focus:border-green-400/50 focus:bg-white/15">
                    
                    <div class="flex flex-wrap gap-x-4 gap-y-2 items-center mt-3 text-xs">
                        <div class="flex items-center gap-1">
                            <span class="text-white">Auto TTS</span>
                            <label class="relative inline-block w-[40px] h-[24px]">
                                <input type="checkbox" id="autoSpeak" class="opacity-0 w-0 h-0 peer" checked>
                                <span class="absolute cursor-pointer top-0 left-0 right-0 bottom-0 bg-white/30 rounded-full transition-colors peer-checked:bg-green-400 before:absolute before:content-[''] before:h-[18px] before:w-[18px] before:left-[3px] before:bottom-[3px] before:bg-white before:rounded-full before:transition-transform peer-checked:before:translate-x-4"></span>
                            </label>
                        </div>
                        <select id="voiceSelect" class="bg-white/10 border border-white/20 rounded-lg px-2 py-1 text-white text-xs appearance-none">
                            <option value="fr-FR-DeniseNeural">Denise</option>
                            <option value="fr-FR-EloiseNeural">Eloise</option>
                            <option value="fr-FR-FabriceNeural">Fabrice</option>
                            <option value="fr-FR-HenriNeural">Henri</option>
                        </select>
                        <div class="flex items-center gap-1">
                            <label class="relative inline-block w-[40px] h-[24px]">
                                <input type="checkbox" id="allowInterrupt" class="opacity-0 w-0 h-0 peer" checked>
                                <span class="absolute cursor-pointer top-0 left-0 right-0 bottom-0 bg-white/30 rounded-full transition-colors peer-checked:bg-green-400 before:absolute before:content-[''] before:h-[18px] before:w-[18px] before:left-[3px] before:bottom-[3px] before:bg-white before:rounded-full before:transition-transform peer-checked:before:translate-x-4"></span>
                            </label>
                            <span class="text-white">Interruption</span>
                        </div>
                    </div>
                    
                    <div class="mt-3 flex justify-between text-xs text-white/60">
                        <div>Cache: <span id="cache-hits" class="text-green-400">0</span></div>
                        <div>Latence: <span id="latency" class="text-blue-400">0ms</span></div>
                        <div>Qualit√©: <span id="quality" class="text-yellow-400">0%</span></div>
                    </div>
                </div>
            </div>
            
            <div class="relative flex-shrink-0 mt-[-200px] flex flex-col items-center">
                <div id="voice-circle" class="w-[200px] h-[200px] rounded-full mx-auto mt-10 mb-2.5 flex items-center justify-center text-6xl transition-all duration-300 bg-white/10 backdrop-blur-xl border-2 border-white/20">
                    <i data-lucide="power-off" class="w-16 h-16"></i>
                </div>

                <div id="status-text" class="text-center text-white text-lg font-medium mt-2">En attente...</div>
                <div id="interrupt-indicator" class="absolute top-[220px] left-1/2 -translate-x-1/2 bg-red-500/80 text-white px-4 py-2 rounded-full text-xs opacity-0 transition-opacity duration-300 pointer-events-none">Interruption d√©tect√©e!</div>
                <div id="processing-indicator" class="absolute top-[250px] left-1/2 -translate-x-1/2 bg-blue-500/80 text-white px-4 py-2 rounded-full text-xs opacity-0 transition-opacity duration-300 pointer-events-none">‚ö° Traitement ultra-rapide...</div>
            </div>
            
            <div id="conversation-area" class="flex-1 overflow-y-auto min-h-0 my-4 p-4 rounded-2xl bg-white/5 backdrop-blur-xl border border-white/10 flex flex-col" style="display: block;">
                <div id="conversation" class="flex-1 flex flex-col justify-end">
                    <div class="text-white/60 text-center italic mt-auto pb-4">
                        Appuyez sur d√©marrer ou envoyez un message...<br>
                        <small class="mt-2 block">‚ö° Mode Ultra-Rapide activ√©!</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="fixed bottom-0 left-0 w-full z-20 p-5 bg-gradient-to-t from-[#1e3a8a] to-transparent">
            <div class="flex flex-col gap-3 mb-3">
                <div class="flex justify-center items-center">
                    <button id="toggleButton" class="flex-1 py-4 rounded-2xl font-semibold text-base transition-all backdrop-blur-xl bg-green-500/80 text-white disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center w-80 gap-2">
                        <i data-lucide="mic" id="toggleButtonIcon"></i> <span id="toggleText">D√©marrer</span>
                    </button>
                </div> 
                
                <div class="flex justify-center items-center gap-2 ">
                    <button id="modeContinu" class="flex-1 py-2 px-3 rounded-lg text-sm font-medium transition-all bg-green-500/80 text-white">
                        üîÑ Continu
                    </button>
                    <button id="modePushToTalk" class="flex-1 py-2 px-3 rounded-lg text-sm font-medium transition-all bg-white/20 text-white/70 hover:bg-white/30">
                        üé§ Push-to-Talk
                    </button>
                </div>
            </div>
            
            <div class="flex gap-2 mb-2">
                <input type="text" id="text-input" placeholder="Envoyer un message..." class="flex-1 bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white text-sm placeholder-white/60 focus:outline-none focus:border-green-400/50 focus:bg-white/15">
                <button id="send-button" class="p-3 bg-green-500/80 rounded-xl text-white hover:bg-green-500/100 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                    </svg>
                </button>
            </div>
            
            <div id="debug" class="flex-shrink-0 bg-black/20 rounded-xl p-2.5 mt-2 text-xs text-white/70 h-[60px] overflow-y-auto hidden">
                <div>‚ö° Syst√®me ultra-rapide pr√™t...</div>
            </div>
        </div>
    </div>

    <audio id="ttsAudio" style="display: none;" preload="none"></audio>

    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.14.0/dist/ort.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ricky0123/vad-web@0.0.22/dist/bundle.min.js"></script>
    
    <script>
        // =============================================
        // üöÄ ASSISTANT VOCAL ULTRA-RAPIDE COMPLET
        // =============================================
        // Variables pour le bouton toggle
        let isRecording = false; // Tracks if continuous recording is active
        let toggleButton, toggleButtonIcon, toggleText;

        // üîß VARIABLES GLOBALES
        let isSettingsExpanded = false; // Initial state: collapsed
        let myVad = null;
        let conversationHistory = [];
        let isPlaying = false; // Is TTS currently playing?
        let currentAudioUrl = null; // To manage object URLs for TTS
        let pipelineActive = false; // True if continuous VAD pipeline is running

        let recordingMode = 'continu'; // 'continu' ou 'push-to-talk'
        let isPushToTalkRecording = false; // Tracks if PTT recording is in progress
        let mediaRecorder = null; // MediaRecorder instance for PTT
        let pushToTalkAudioChunks = []; // Stores audio data for PTT
        let audioStream = null; // The getUserMedia audio stream
        let audioContext = null; // AudioContext for VAD (if needed) and audio processing

        let modeContinuButton, modePushToTalkButton;

        const transcriptionCache = new Map();
        const ttsCache = new Map();
        const MAX_CACHE_SIZE = 50;
        const baseCircleClasses = "w-[200px] h-[200px] rounded-full mx-auto mt-10 mb-2.5 flex items-center justify-center text-6xl transition-all duration-300 backdrop-blur-xl";
        
        // üîß √âL√âMENTS DOM (Assurez-vous que tous ces IDs correspondent √† votre HTML)
        let groqApiKeyInput, openaiApiKeyInput, settingsToggle, settingsContent, settingsToggleIcon;
        let voiceCircle, statusText, debug, conversation, autoSpeakCheckbox;
        let allowInterruptCheckbox, voiceSelect, ttsAudio, interruptIndicator;
        let processingIndicator, cacheHitsElement, latencyElement, qualityElement;
        let textInput, sendButton;

        // üí≠ NOUVELLES VARIABLES R√âFLEXIONS SIMPLES (si tu comptes les utiliser)
        const SIMPLE_REFLECTIONS = [
            "Ah oui, je vois...", "D'accord, tr√®s bien...", "OK, ok je comprends...",
            "Hmm, int√©ressant...", "Oui, ok , effectivement...", "Ah, parfait...",
            "Tr√®s bien, ok ,ok ...", "OK, laissez-moi voir...", "D'accord, ok , ok ...",
            "Ah, bien s√ªr , Ok...", "Oui, d'accord,d'accord...", "Je comprends bien...", "Oui, tout √† fait..."
        ];

        // =============================================
        // üîß FONCTIONS UTILITAIRES
        // =============================================
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('fr-FR');
            const emoji = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ö°';
            const logMessage = `${timestamp} ${emoji} ${message}`;
            
            console.log(logMessage);
            if (debug) {
                const newLine = document.createElement('div');
                newLine.textContent = logMessage;
                newLine.className = type === 'error' ? 'text-red-300' : type === 'success' ? 'text-green-300' : type === 'warning' ? 'text-yellow-300' : '';
                // Add new line at the top
                debug.insertBefore(newLine, debug.firstChild);
                
                // Keep only a reasonable number of log lines to prevent overflow
                while (debug.children.length > 10) {
                    debug.removeChild(debug.lastChild);
                }
            }
        }
        
        function toggleSettings() {
            if (!settingsContent || !settingsToggleIcon) {
                log('Erreur: √âl√©ments des param√®tres non trouv√©s. V√©rifiez les IDs HTML.', 'error');
                return;
            }

            isSettingsExpanded = !isSettingsExpanded;
            if (isSettingsExpanded) {
                // Set a fixed large maxHeight for the transition to work
                settingsContent.style.maxHeight = '500px'; 
                settingsContent.style.paddingBottom = '20px';
                settingsContent.style.opacity = '1';
                settingsToggleIcon.textContent = '‚¨ÜÔ∏è'; 
                log('Param√®tres d√©ploy√©s', 'info');
            } else {
                settingsContent.style.maxHeight = '0px';
                settingsContent.style.paddingBottom = '0px';
                settingsContent.style.opacity = '0';
                settingsToggleIcon.textContent = '‚¨áÔ∏è'; 
                log('Param√®tres r√©tract√©s', 'info');
            }
        }
        
        function updateStatus(text, emoji, stateClass) {
            if (!statusText || !voiceCircle) return;
            
            statusText.textContent = text;

            let iconName = 'power-off'; // Default icon for "En attente..."
            switch (stateClass) {
                case "listening": iconName = 'mic'; break;
                case "speaking": 
                case "tts-playing": iconName = 'volume-2'; break;
                case "processing": iconName = 'loader-circle'; break;
                case "interrupted": iconName = 'zap-off'; break;
                case "recording-ptt": iconName = 'mic-vibrate'; break; 
                default: iconName = 'power-off';
            }
            // Update the voice circle icon and ensure Lucide re-renders it
            voiceCircle.innerHTML = `<i data-lucide="${iconName}" class="w-16 h-16"></i>`;
            lucide.createIcons(); 

            // Manage visibility of processing and interrupt indicators
            processingIndicator?.classList.remove('opacity-100');
            interruptIndicator?.classList.remove('opacity-100');
            
            // Apply appropriate styling classes to the voice circle
            let stateClasses = "";
            switch (stateClass) {
                case "listening": stateClasses = "bg-green-400/20 border-2 border-green-400/40 animate-pulse"; break;
                case "speaking": stateClasses = "bg-green-600/30 border-2 border-green-600/50"; break;
                case "processing":
                    stateClasses = "bg-amber-400/20 border-2 border-amber-400/40";
                    // For processing, we use loader-circle with an explicit spin animation
                    voiceCircle.innerHTML = `<i data-lucide="loader-circle" class="w-16 h-16 animate-processing-spin"></i>`;
                    lucide.createIcons(); 
                    processingIndicator?.classList.add('opacity-100');
                    break;
                case "tts-playing": stateCla